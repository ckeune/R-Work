{
    "contents" : "##\n##install packages if not already done so (uncomment)\n##\n# install.packages(\"circlize\")\n# install.packages(\"plyr\")\n\n##\n##read in table and define matrix (m) and reference data.frame (DIRSource1)\n##\nm<-read.table(system.file(\"science\", \"region_custom.txt\", package = \"migest\"), skip=2, stringsAsFactors=FALSE)\nsources <-read.table(system.file(\"science\", \"region_custom.txt\", package = \"migest\"), skip=2, stringsAsFactors=FALSE)\nDIRSource1 <- data.frame(DIRSource1)\n#data.frame for details on each region\nDIRSource1<-m[,1:3]\nnames(DIRSource1)<-c(\"order\",\"rgb\",\"region\")\nDIRSource1$region<-gsub(\"_\", \" \", DIRSource1$region)\n\n#flow matrix\nm<-m[,-(1:3)]/1e06\nm<-as.matrix(m1)\ndimnames(m1)<-list(orig=DIRSource1$region,dest=DIRSource1$region)\n\n##\n##sort order of data.frame and matrix for plotting in circos\n##\nlibrary(\"plyr\")\nDIRSource1<-arrange(DIRSource1, order)\nDIRSource1$region <- factor(DIRSource1$region, levels=DIRSource1$region)\nm<-m[levels(DIRSource1$region),levels(DIRSource1$region)]\n\n##\n##define ranges of circos sectors and their colors (both of the sectors and the links)\n##\nDIRSource1$xmin <- 0\nDIRSource1$xmax <- rowSums(m)+colSums(m)\nn<-nrow(DIRSource1)\nDIRSource1 <- cbind(DIRSource1, matrix(as.numeric(unlist(strsplit(DIRSource1$rgb,\",\"))),nrow=n, byrow=TRUE) )\nnames(DIRSource1)[ncol(DIRSource1)-2:0]<-c(\"r\",\"g\",\"b\")\nDIRSource1$rcol<-rgb(DIRSource1$r, DIRSource1$g, DIRSource1$b, max = 255)\nDIRSource1$lcol<-rgb(DIRSource1$r, DIRSource1$g, DIRSource1$b, alpha=200, max = 255)\n\n##\n##plot sectors\n##\nlibrary(\"circlize\")\npar(mar=rep(0,4))\ncircos.clear()\n\n#basic circos graphic parameters\ncircos.par(cell.padding=c(0,0,0,0), track.margin=c(0,0.1), start.degree = 90, gap.degree =4)\n\n#sector details\ncircos.initialize(factors = DIRSource1$region, xlim = cbind(DIRSource1$xmin, DIRSource1$xmax))\n\n#plot sectors\ncircos.trackPlotRegion(ylim = c(0, 1), factors = DIRSource1$region, track.height=0.1, bg.border = NA, bg.col = NA, bg.lty =0, bg.lwd=0.0001,\n                       #panel.fun for each sector\n                       panel.fun = function(x, y) {\n                         #select details of current sector\n                         name = get.cell.meta.data(\"sector.index\")\n                         i = get.cell.meta.data(\"sector.numeric.index\")\n                         xlim = get.cell.meta.data(\"xlim\")\n                         ylim = get.cell.meta.data(\"ylim\")\n                         \n                         #plot country labels\n                         circos.text(x=mean(xlim), y=2.2, labels=name, facing = \"bending\", cex=0.8)\n                         #                          \n                         #                          #plot main sector\n                         circos.rect(xleft=xlim[1], ybottom=ylim[1], xright=xlim[2], ytop=ylim[2], \n                                     col = DIRSource1$rcol[i], border=DIRSource1$rcol[i])\n                         #                          \n                         #                          #blank in part of main sector\n                         #                          circos.rect(xleft=xlim[1], ybottom=ylim[1], xright=xlim[2]-rowSums(m)[i], ytop=ylim[1]+0.3, \n                         #                                      col = \"white\", border = \"white\")\n                         #                          \n                         #                          #white line all the way around\n                         #                          circos.rect(xleft=xlim[1], ybottom=0.3, xright=xlim[2], ytop=0.32, col = \"white\", border = \"white\")\n                         #                          \n                         #                          #plot axis\n                         #                          circos.axis(labels.cex=0.8, direction = \"outside\", major.at=seq(0,floor(DIRSource1$xmax)[i]), minor.ticks=1,\n                         #                                      labels.away.percentage = 0.15)\n                       })\n\n\n##\n##plot links\n##\n#add sum values to DIRSource1, marking the x-position of the first links out (sum1) and in (sum2). Updated for further links in loop below.\nDIRSource1$sum1 <- colSums(m)\nDIRSource1$sum2 <- numeric(n)\n\n#create a data.frame of the flow matrix sorted by flow size, to allow largest flow plotted first\ndf2<-cbind(as.data.frame(m),orig=rownames(m),  stringsAsFactors=FALSE)\ndf2<-reshape(df2, idvar=\"orig\", varying=list(1:n), direction=\"long\", timevar=\"dest\", time=rownames(m),  v.names = \"m\")\ndf2<-arrange(df2,desc(m))\n\n#keep only the largest flows to avoid clutter\ndf2<-subset(df2, m>quantile(m,0.65))\n\n\nfor(k in 1:nrow(df2)){\n  #i,j reference of flow matrix\n  i<-match(df2$orig[k],DIRSource1$region)\n  j<-match(df2$dest[k],DIRSource1$region)\n  \n  #plot link\n  circos.link(sector.index1=DIRSource1$region[i], point1=c(DIRSource1$sum1[i], DIRSource1$sum1[i] + abs(m[i, j])),\n              sector.index2=DIRSource1$region[j], point2=c(DIRSource1$sum2[j], DIRSource1$sum2[j] + abs(m[i, j])),\n              col = DIRSource1$lcol[i])\n  \n  #update sum1 and sum2 for use when plotting the next link\n  DIRSource1$sum1[i] = DIRSource1$sum1[i] + abs(m[i, j])\n  DIRSource1$sum2[j] = DIRSource1$sum2[j] + abs(m[i, j])\n}\n\n#remove created objects\n#rm(DIRSource1,df2,m,i,j,k,n)\n",
    "created" : 1422997001211.000,
    "dirty" : true,
    "encoding" : "",
    "folds" : "",
    "hash" : "3241168678",
    "id" : "E4FD8180",
    "lastKnownWriteTime" : 12948304202498162,
    "path" : null,
    "project_path" : null,
    "properties" : {
        "tempName" : "Untitled9"
    },
    "source_on_save" : false,
    "type" : "r_source"
}